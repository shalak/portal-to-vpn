user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

stream {
    # Log TCP (HTTPS) connections to stdout
    log_format stream_log '$remote_addr [$time_local] '
                          'SNI="$ssl_preread_server_name" '
                          'sent=$bytes_sent received=$bytes_received '
                          'duration=$session_time';

    access_log /dev/stdout stream_log;

    # Gluetun runs its DNS resolver on 127.0.0.1 inside the
    # shared network namespace.
    resolver 127.0.0.1 valid=30s;
    resolver_timeout 5s;

    # TCP SNI-based proxy: forward to whatever hostname was requested.
    server {
        listen 443;
        ssl_preread on;

        # Use the SNI hostname as upstream, no hardcoded domain.
        proxy_pass $ssl_preread_server_name:443;

        proxy_connect_timeout 10s;
        proxy_timeout 60s;
    }
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Log HTTP to stdout as well
    access_log  /dev/stdout;

    sendfile        on;
    keepalive_timeout  65;

    # Don't use disk temp files for proxying
    proxy_max_temp_file_size 0;

    # Use Gluetun's DNS inside the shared netns
    resolver 127.0.0.1 valid=30s;
    resolver_timeout 5s;

    server {
        listen 80 default_server;

        # Transparent HTTP proxy through VPN:
        # - Preserve Host
        # - Do NOT send X-Real-IP / X-Forwarded-For (don't leak client IP)
        location / {
            proxy_set_header Host $host;

            proxy_connect_timeout 10s;
            proxy_read_timeout    60s;

            proxy_pass http://$host$request_uri;
        }
    }
}
