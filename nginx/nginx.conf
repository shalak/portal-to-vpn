user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

stream {
    # Gluetun runs its DNS resolver on 127.0.0.1 inside the
    # shared network namespace.
    resolver 127.0.0.1 valid=30s;
    resolver_timeout 5s;

    # TCP SNI-based proxy: forward to whatever hostname was requested.
    server {
        listen 443;
        ssl_preread on;

        # Use the SNI hostname as upstream, no hardcoded domain.
        proxy_pass $ssl_preread_server_name:443;

        proxy_connect_timeout 10s;
        proxy_timeout 60s;
    }
}
